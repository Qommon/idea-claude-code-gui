# VSCode 智能体选择后出现 “API request failed” 的原因说明

这份文档用通俗方式说明：为什么**不选智能体能用、选了智能体就报错**，以及修复做了什么。

## 现象

- 不选择智能体：对话正常。
- 选择智能体：100% 报错，提示 `API request failed`，并显示当前 API Key 与 Base URL。

## 为什么只在选择智能体时出现

选择智能体后，前端会把“你的消息 + 智能体的提示词”一起打包发送。
这让发送的数据从“简单文本”变成了“带结构的 JSON 数据”。

旧的 VSCode 桥接程序只按“纯文本”去处理这类消息，导致：

- 智能体提示词没有被传给 Claude。
- 在某些情况下，消息内容被当成“空”或“格式不完整”。

而 Claude 这边收到“空/不完整”的请求时，通常只会返回一个通用错误：`API request failed`。

## 根因（用人话）

**问题不在你的 API Key，也不在 Base URL 本身，而在“中间转发”这一层。**

简单说：

1. 选择智能体后，消息结构变复杂了。
2. VSCode 端的桥接程序没有正确解析这类结构化消息。
3. 结果就是：Claude 收到的请求不完整，于是返回 `API request failed`。

## 修复做了什么

修复后的逻辑做了三件关键事：

1. **先把消息“规范化”**：无论是纯文本还是结构化 JSON，都能正确识别出“用户消息内容”。
2. **把智能体提示词真正传给 Claude**：避免消息被当成“空”或“格式异常”。
3. **清理隐藏控制字符**：避免一些不可见字符破坏请求格式。

这样 Claude 收到的请求就完整、稳定了，所以不再报错。

## 现在的行为

- 选择智能体：正常工作，提示词会生效。
- 不选择智能体：仍然正常。

## 如果以后再遇到类似问题

可以先做两件最简单的排查：

1. **换回不选智能体试一次**  
   如果不选就能用，基本可以判断是“消息结构解析”或“智能体提示词”相关问题。

2. **临时切换到官方 Base URL**  
   用 `https://api.anthropic.com` 试一下，排除代理兼容性问题。

如果需要进一步排查，可以查看 VSCode 输出面板里的 `ai-bridge` 日志。
